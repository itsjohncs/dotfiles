#!/usr/bin/env bash

set -euo pipefail

## Interactive rebase (automatically chooses target)

usage() {
    echo "Usage: gi [TARGET]"
    echo "Run 'git rebase -i TARGET'."
    echo "If TARGET is not provided, uses the upstream of the current branch if set; otherwise defaults to 'origin/main'."
}

if [[ ${1-} == "-h" || ${1-} == "--help" ]]; then
    usage
    exit 2
fi

if [[ $# -gt 1 ]]; then
    echo "Error: too many arguments." >&2
    echo >&2
    usage >&2
    exit 2
fi

# Ensure we're inside a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: not inside a git repository." >&2
    exit 1
fi

if [[ $# -eq 1 ]]; then
    TARGET="$1"
else
    # Try to get the upstream of the current branch
    upstream="$(git rev-parse --abbrev-ref --symbolic-full-name '@{upstream}' 2>/dev/null || true)"
    if [[ -n ${upstream:-} ]]; then
        TARGET="$upstream"
    else
        TARGET="origin/main"
    fi
fi

echo "+ git rebase -i $TARGET"
exec git rebase -i "$TARGET"
