#!/usr/bin/env bash

set -euo pipefail

## Interactive rebase (automatically chooses target)

usage() {
    echo "Usage: gi [TARGET]"
    echo "Run 'git rebase -i TARGET'."
    echo "If TARGET is not provided, prefers branch.<name>.base (if set); else uses the upstream of the current branch; otherwise uses the merge-base of 'origin/main' and 'HEAD'."
}

if [[ ${1-} == "-h" || ${1-} == "--help" ]]; then
    usage
    exit 2
fi

if [[ $# -gt 1 ]]; then
    echo "Error: too many arguments." >&2
    echo >&2
    usage >&2
    exit 2
fi

# Ensure we're inside a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: not inside a git repository." >&2
    exit 1
fi

if [[ $# -eq 1 ]]; then
    TARGET="$1"
else
    # Prefer per-branch 'base' if configured (via src/scripts/base)
    base_cfg="$(base 2>/dev/null || true)"

    if [[ -n ${base_cfg:-} ]]; then
        TARGET="$base_cfg"
    else
        # Try to get the upstream of the current branch
        upstream="$(git rev-parse --abbrev-ref --symbolic-full-name '@{upstream}' 2>/dev/null || true)"
        if [[ -n ${upstream:-} ]]; then
            TARGET="$upstream"
        else
            # Use the merge base between origin/main and the current HEAD
            TARGET="$(git merge-base origin/main HEAD)"
        fi
    fi
fi

echo "+ git rebase -i $TARGET"
exec git rebase -i "$TARGET"
